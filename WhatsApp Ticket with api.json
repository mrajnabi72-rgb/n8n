{
  "name": "WhatsApp Ticket with api",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "WhatsApp Ticket with Api",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "4737074d-9ada-47a5-8e0f-81f25167c4a3",
      "name": "Received message WhatsApp",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -2896,
        -1760
      ],
      "webhookId": "7281248c-e294-4b51-b151-30609b324a88"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "b51c084f-60d6-41d7-b088-7219813dbefa",
              "leftValue": "={{ $json.type }}",
              "rightValue": "CREATE",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2336,
        -1760
      ],
      "id": "33951805-9225-446d-a0d8-7d53060c884b",
      "name": "If"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -1488,
        -1728
      ],
      "id": "de8658cf-9e27-4ca8-bf59-efeced0f2f61",
      "name": "Respond to WhatsApp"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -1904,
        -1584
      ],
      "id": "9dfd5a0d-751c-4283-91ff-9490372cbcbd",
      "name": "Respond to WhatsApp-1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://query.invadertech.com/mobile/QueryService.svc/AddTicketWA",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"sessionId\": {{ JSON.stringify($('Received message WhatsApp').item.json.body.sessionId) }},\n  \"displayName\": {{ JSON.stringify($('Received message WhatsApp').item.json.body.displayName) }},\n  \"isGroup\": {{ $('Received message WhatsApp').item.json.body.isGroup || false }},\n  \"sender\": {{ JSON.stringify($('Received message WhatsApp').item.json.body.sender) }},\n  \"replyTo\": {{ JSON.stringify($('Received message WhatsApp').item.json.body.replyTo) }},\n  \"groupId\": {{ JSON.stringify($('Received message WhatsApp').item.json.body.groupId || null) }},\n  \"groupName\": {{ JSON.stringify($('Received message WhatsApp').item.json.body.groupName || null) }},\n  \"timestamp\": {{ JSON.stringify($('Received message WhatsApp').item.json.body.timestamp) }},\n  \"type\": {{ JSON.stringify($('Received message WhatsApp').item.json.body.type) }},\n  \"message\": {{ JSON.stringify($('Received message WhatsApp').item.json.body.message || \"\") }},\n  \"media\": null,\n  \"mimeType\": {{ JSON.stringify($json.mediaUrl?.mimeType || null) }},\n  \"fileName\": {{ JSON.stringify($json.mediaUrl?.fileName || null) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1904,
        -1920
      ],
      "id": "f37b0e1a-01e7-4aec-adc4-9263b2c79377",
      "name": "Query Manager-Api"
    },
    {
      "parameters": {
        "language": "javascript",
        "jsCode": "const data = $input.first()?.json || {};\nconst body = data.body || data || {};\n\n\n// =====================\n// READ MESSAGE\n// =====================\nconst rawText =\n  body.message ??\n  body.text ??\n  body.chatInput ??\n  \"\";\n\nconst message = String(rawText).trim().toLowerCase();\n\n// =====================\n// MEDIA DETECTION\n// =====================\nconst hasMedia =\n  body.type === \"image\" ||\n  body.type === \"video\" ||\n  body.type === \"audio\" ||\n  body.type === \"document\" ||\n  body.type === \"pdf\" ||\n  body.media !== null ||\n  body.mediaUrl !== undefined;\n\nconst mediaType = body.type || \"unknown\";\nconst mediaUrl = body.mediaUrl || body.media || null;\nconst fileName = body.fileName || null;\n\n// =====================\n// GREETING WORDS\n// =====================\nconst greetings = [\n  \"hi\", \"hello\", \"hey\", \"hii\",\n  \"how are you\", \"good morning\",\n  \"good evening\", \"good afternoon\",\n  \"à¤¨à¤®à¤¸à¥à¤¤à¥‡\", \"à¤¹à¥‡à¤²à¥‹\", \"à¤°à¤¾à¤® à¤°à¤¾à¤®\"\n];\n\n// =====================\n// THANK YOU WORDS\n// =====================\nconst thanksWords = [\n  \"thanks\", \"thank you\", \"thx\", \"ty\",\n  \"ok\", \"okay\", \"fine\", \"cool\",\n  \"nice\", \"great\", \"ðŸ‘\", \"ðŸ™\",\n  \"à¤§à¤¨à¥à¤¯à¤µà¤¾à¤¦\", \"à¤¶à¥à¤•à¥à¤°à¤¿à¤¯à¤¾\", \"à¤¬à¤¹à¥à¤¤ à¤§à¤¨à¥à¤¯à¤µà¤¾à¤¦\"\n];\n\n// =====================\n// RANDOM MEDIA REPLIES (ENGLISH)\n// =====================\nconst randomMediaReplies = [\n  \"ðŸ“¸ Thank you for sharing the image. We couldnâ€™t clearly identify the issue from the photo. Could you please describe the problem youâ€™re facing so we can assist you better?\",\n  \"ðŸ‘€ Weâ€™ve received your image, but the issue is not clearly visible. Kindly provide a short description of the problem for faster support.\",\n  \"ðŸ‘ Image received successfully. To help you accurately, please let us know the exact issue you are experiencing.\",\n  \"ðŸ“Ž Thanks for the media. We are unable to determine the concern from the file alone. Please share a brief explanation of the problem.\",\n  \"ðŸ“¸ Weâ€™ve received your image, but we couldnâ€™t identify a specific issue. Could you please share a brief description of the problem so we can assist you quickly?\"\n];\n\n// =====================\n// PROBLEM KEYWORDS (EXTENDED)\n// =====================\nconst problemKeywords = [\n  \"Invader Technology Pvt.Ltd.\",\n  \"problem\", \"issue\", \"error\",  \n  \"not found\", \"404\", \"not working\", \"failed\",\n  \"unable\", \"can't\", \"cannot\", \"complaint\", \"help\",\n  \"support\", \"bug\", \"crash\", \"slow\", \"down\",\n\n  \"app not opening\", \"app crash\", \"system error\",\n  \"page not loading\", \"screen stuck\", \"frozen\",\n  \"server error\", \"timeout\", \"something went wrong\",\n\n  \"login issue\", \"login failed\", \"unable to login\",\n  \"account issue\", \"account blocked\", \"account suspended\",\n  \"password issue\", \"forgot password\", \"otp issue\",\n\n  \"payment issue\", \"payment failed\", \"payment pending\",\n  \"amount deducted\", \"double payment\", \"refund\",\n  \"refund pending\", \"billing issue\", \"transaction failed\",\n\n  \"internet issue\", \"network issue\", \"no internet\",\n  \"connection problem\", \"slow internet\",\n\n  \"file not uploading\", \"upload failed\",\n  \"download issue\", \"file missing\", \"file corrupted\",\n\n  \"slow response\", \"lag\", \"delay\", \"taking too long\",\n  \"technical issue\", \"service down\", \"not responding\",\n  \"error message\", \"issue persists\",\n  // Hindi\n  \"à¤¸à¥‡à¤µà¤¾\",\n  \"à¤‡à¤¨à¤µà¥‡à¤¡à¤° à¤Ÿà¥‡à¤•à¥à¤¨à¥‹à¤²à¥‰à¤œà¥€ à¤ªà¥à¤°à¤¾à¤‡à¤µà¥‡à¤Ÿ à¤²à¤¿à¤®à¤¿à¤Ÿà¥‡à¤¡\",\n  \"à¤‡à¤¨à¤µà¥‡à¤¡à¤° à¤Ÿà¥ˆà¤•à¥à¤œà¥‹à¤²à¥‹à¤šà¥à¤²à¤¿à¤œ à¤ªà¥à¤°à¤¾à¤ˆà¤µà¥‡à¤Ÿ à¤²à¤¿à¤®à¤¿à¤Ÿà¥‡à¤¡\",\n  \"à¤‡à¤¨à¤¬à¤¡à¥‡à¤° à¤Ÿà¥‡à¤•à¥à¤¨à¥‰à¤²à¤¾à¤œà¥€ à¤ªà¥à¤°à¤¾. à¤²à¤¿.\",\n  \"à¤‡à¤¨à¥à¤µà¥‡à¤¡à¤°\",\n  \"à¤•à¤¾à¤® à¤¨à¤¹à¥€à¤‚ à¤•à¤° à¤°à¤¹à¤¾\",\n  \"à¤•à¤¾à¤® à¤¨à¤¹à¥€à¤‚ à¤•à¤° à¤°à¤¹à¥€\",\n  \"à¤¨à¤¹à¥€à¤‚ à¤¹à¥‹ à¤°à¤¹à¤¾\",\n  \"à¤¨à¤¹à¥€à¤‚ à¤¹à¥‹ à¤ªà¤¾ à¤°à¤¹à¤¾\",\n  \"à¤¨à¤¹à¥€à¤‚ à¤¹à¥‹ à¤°à¤¹à¥€\",\n  \"à¤¨à¤¹à¥€à¤‚ à¤šà¤² à¤°à¤¹à¤¾\",\n  \"à¤¨à¤¹à¥€à¤‚ à¤šà¤² à¤°à¤¹à¥€\",\n  \"à¤°à¥à¤• à¤—à¤¯à¤¾\",\n  \"à¤°à¥à¤• à¤—à¤ˆ\",\n  \"à¤¬à¤‚à¤¦ à¤¹à¥‹ à¤—à¤¯à¤¾\",\n  \"à¤¬à¤‚à¤¦ à¤¹à¥‹ à¤—à¤ˆ\",\n  \"à¤²à¥‰à¤—à¤¿à¤¨ à¤¨à¤¹à¥€à¤‚ à¤¹à¥‹ à¤°à¤¹à¤¾\",\n  \"à¤­à¥à¤—à¤¤à¤¾à¤¨ à¤¨à¤¹à¥€à¤‚ à¤¹à¥‹ à¤°à¤¹à¤¾\",\n  \"à¤ªà¥‡à¤®à¥‡à¤‚à¤Ÿ à¤«à¥‡à¤²\",\n  \"à¤°à¤¿à¤«à¤‚à¤¡ à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾\",\n  \"à¤ªà¥ˆà¤¸à¥‡ à¤•à¤Ÿ à¤—à¤\",\n  \"à¤°à¤¾à¤¶à¤¿ à¤•à¤Ÿ à¤—à¤ˆ\",\n  \"à¤¨à¥‡à¤Ÿà¤µà¤°à¥à¤• à¤¨à¤¹à¥€à¤‚ à¤† à¤°à¤¹à¤¾\",\n  \"à¤‡à¤‚à¤Ÿà¤°à¤¨à¥‡à¤Ÿ à¤¨à¤¹à¥€à¤‚ à¤šà¤² à¤°à¤¹à¤¾\",\n  \"à¤¸à¤°à¥à¤µà¤° à¤¡à¤¾à¤‰à¤¨\",\n  \"à¤à¤ª à¤¨à¤¹à¥€à¤‚ à¤–à¥à¤² à¤°à¤¹à¥€\",\n  \"à¤à¤ª à¤¨à¤¹à¥€à¤‚ à¤šà¤² à¤°à¤¹à¥€\",\n  \"à¤“à¤Ÿà¥€à¤ªà¥€ à¤¨à¤¹à¥€à¤‚ à¤† à¤°à¤¹à¤¾\",\n  \"à¤–à¤¾à¤¤à¤¾ à¤¬à¥à¤²à¥‰à¤• à¤¹à¥‹ à¤—à¤¯à¤¾\",\n  \"à¤ªà¤¾à¤¸à¤µà¤°à¥à¤¡ à¤—à¤²à¤¤\",\n  \"à¤²à¥‡à¤¨à¤¦à¥‡à¤¨ à¤…à¤¸à¤«à¤²\",\n  \"à¤¸à¤¿à¤¸à¥à¤Ÿà¤® à¤à¤°à¤°\",\n  \"à¤ªà¥‡à¤œ à¤²à¥‹à¤¡ à¤¨à¤¹à¥€à¤‚ à¤¹à¥‹ à¤°à¤¹à¤¾\",\n  \"à¤¸à¥à¤•à¥à¤°à¥€à¤¨ à¤«à¥à¤°à¥€à¤œ\"\n];\n\n// =====================\n// INDIA TIME\n// =====================\nconst now = new Date();\nconst createdAt = now.toLocaleString(\"en-IN\", {\n  timeZone: \"Asia/Kolkata\",\n  day: \"2-digit\",\n  month: \"short\",\n  year: \"numeric\",\n  hour: \"2-digit\",\n  minute: \"2-digit\",\n  second: \"2-digit\",\n  hour12: true,\n});\n\n// =====================\n// TICKET NUMBER\n// =====================\nconst yyyy = now.getFullYear();\nconst mm = String(now.getMonth() + 1).padStart(2, \"0\");\nconst dd = String(now.getDate()).padStart(2, \"0\");\nconst hh = String(now.getHours()).padStart(2, \"0\");\nconst mi = String(now.getMinutes()).padStart(2, \"0\");\nconst ss = String(now.getSeconds()).padStart(2, \"0\");\n\nconst ticketNo = `TK_NO-${yyyy}${mm}${dd}-${hh}${mi}${ss}`;\n\n// =====================\n// COMMON RESPONSE FORMAT\n// =====================\nfunction response(data) {\n  return [{\n    json: {\n      reply: true,\n      type: data.type || null,\n      ticket: data.ticket || null,\n      ticketStatus: data.ticketStatus || null,\n      userIssue: data.userIssue || null,\n      mediaType: data.mediaType || null,\n      mediaUrl: data.mediaUrl || null,\n      fileName: data.fileName || null,\n      createdAt: data.createdAt || null,\n      message: data.message || null\n    }\n  }];\n}\n\n// =====================\n// STATUS CHECK\n// =====================\nconst ticketMatch = message.match(/tk_no-\\d+/i);\nif (ticketMatch) {\n  return response({\n    type: \"STATUS\",\n    ticket: ticketMatch[0].toUpperCase(),\n    message: `ðŸ” Checking status for ticket ${ticketMatch[0].toUpperCase()}`\n  });\n}\n\n// =====================\n// GREETING CHECK\n// =====================\nconst isGreeting = greetings.some(g =>\n  message === g || message.startsWith(g)\n);\n\nif (isGreeting) {\n  return response({\n    type: \"GREETING\",\n    message: \"ðŸ‘‹ Hello! Please tell me your issue so I can assist you.\"\n  });\n}\n\n// =====================\n// MEDIA HANDLING\n// =====================\nif (hasMedia) {\n\n  const hasProblemInMedia = problemKeywords.some(k =>\n    message.includes(k)\n  );\n\n  // âœ… Media + Problem â†’ Create Ticket\n  if (hasProblemInMedia && message.length > 3) {\n    return response({\n      type: \"CREATE\",\n      ticket: ticketNo,\n      ticketStatus: \"OPEN\",\n      userIssue: message,\n      mediaType,\n      mediaUrl,\n      fileName,\n      createdAt,\n      message:\n        `ðŸ“Ž Media received successfully.\\n` +\n        `âœ… Your ticket has been created.\\n` +\n        `ðŸŽ« Ticket No: ${ticketNo}\\n` +\n        `ðŸ—‚ï¸ File Type: ${mediaType}\\n` +\n        `ðŸ•’ Time: ${createdAt}\\n` +\n        `Our support team will review it shortly.`\n    });\n  }\n\n  // âŒ Media only â†’ Random reply\n  const randomReply =\n    randomMediaReplies[Math.floor(Math.random() * randomMediaReplies.length)];\n\n  return response({\n    type: \"MEDIA_ONLY\",\n    mediaType,\n    mediaUrl,\n    fileName,\n    createdAt,\n    message: randomReply\n  });\n}\n\n// =====================\n// TEXT PROBLEM CHECK\n// =====================\nconst isProblem = problemKeywords.some(k =>\n  message.includes(k)\n);\n\nif (isProblem && message.length > 3) {\n  return response({\n    type: \"CREATE\",\n    ticket: ticketNo,\n    ticketStatus: \"OPEN\",\n    userIssue: message,\n    createdAt,\n    message:\n      `âœ… Your ticket has been created successfully.\\n` +\n      `ðŸŽ« Ticket No: ${ticketNo}\\n` +\n      `ðŸ•’ Time: ${createdAt}\\n` +\n      `Our team will contact you shortly.`\n  });\n}\n\n// =====================\n// THANK YOU CHECK\n// =====================\nconst isThanks = thanksWords.some(w =>\n  message.includes(w)\n);\n\nif (isThanks) {\n  return response({\n    type: \"THANKS\",\n    message: \"ðŸ˜Š Youâ€™re welcome! Let me know if you need any further help.\"\n  });\n}\n\n// =====================\n// UNKNOWN MESSAGE\n// =====================\nreturn response({\n  type: \"UNKNOWN\",\n  message:\n    \"ðŸ‘‹ Hello! Please describe your problem so I can create a support ticket.\"\n});"
      },
      "id": "93b5ac66-c29a-42a4-92f0-345d31ea85a8",
      "name": "Generate Ticket(JavaScript)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -2624,
        -1760
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Received message WhatsApp": {
      "main": [
        [
          {
            "node": "Generate Ticket(JavaScript)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Query Manager-Api",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to WhatsApp-1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Manager-Api": {
      "main": [
        [
          {
            "node": "Respond to WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Ticket(JavaScript)": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "119c2e0a-3f46-4663-b582-bd26cdb45c72",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "fc8ea56a9f77461efdbaf4ab14000fda259d6eb0a0ad047cd98c8f84ded3bdb0"
  },
  "id": "sFVlnBAZ0VqsJip2",
  "tags": []
}